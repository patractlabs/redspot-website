## Overview

### Get Started Immediately

```
$ npx redspot-new erc20
```

(npx is a package runner tool that comes with npm 5.2+ and higher, it ensures that you always install the latest version)

Redspot will create a directory called flipper inside the current folder.

Once the installation is done, you can open your project folder:

```
$ cd erc20
```

Inside the newly created project, you can run some built-in commands:

#### `npx redspot compile`

Compile your contract into wasm

#### `npx redspot test`

Test your contract

#### `npx redspot console`

Open the interactive javascript console

#### `npx redspot help`

Get help information

![](https://user-images.githubusercontent.com/69485494/97970303-344d3e00-1e26-11eb-9030-843ea77bdd31.gif)

### Install from template

Redspot provides several contract templates: `flipper`, `delegator` , `dns`, `erc20`, `erc721` , `incrementer`, `multisig_plain`. You can intall them like this:

```
$ npx redspot-new <app-name> --template <template-name>
```

For instance: `npx redspot-new flipper --template flipper`

The default contract template is `erc20`.

### Directory tree

```
app-name/
    |-.vscode/
        |-launch.json
    |-artifacts/
        |- <would store compile contract artifacts, e.g. contracts abi(json) and wasm files>
    |-contracts/
    		|-lib.rs
        |-Cargo.toml
    |-scripts
    		|-deploy.ts
    |-node_modules/
        |- ...
    |-tests/
        |-<template-name>.test.ts
    |-package.json
    |-redspot.config.js
    |-tsconfig.json
```

- The files generated by `npx redspot compile` are in `artifacts` folder by default. There are compile artifacts for contracts, like contract **abi and wasm** files.
- `test` keeps test files. There are used for test contracts.

### Compile contract

Use command `npx redspot compile` to compile the contracts and abi files used for generating contracts in project. This command can compile both main contract and sub-contract, but please notice that it can only produce the abi files of the main contract. (Will be resolved in the future https://github.com/paritytech/cargo-contract/issues/60)

Prerequisites:

- rust nightly: https://rust-lang.github.io/rustup/installation/index.html#installing-nightly
- rust-src: `rustup component add rust-src --toolchain nightly`
- wasm-opt: https://github.com/WebAssembly/binaryen#tools
- cargo contract v0.7.1: `cargo install --git https://github.com/paritytech/cargo-contract cargo-contract --force`

You can specify the contract name to compile, by default it compiles all contracts in the workspace.

```
$ npx redspot compile --package <ContractName>
```

You can also specify the toolchain needed by compilation. The default one is nightly:

```
$ npx redspot compile --toolchain stable
```

The files generated by compilation will be in `artifacts` directory by default.

### Testing contract

The sample project comes with these tests that use `@redspot/patract` and `@redspot/chai`.

```javascript
import BN from 'bn.js';
import { expect } from 'chai';
import { patract } from 'redspot';

const {
  disconnect,
  getContractFactory,
  getRandomSigner,
  getSigners,
  getAbi,
  api
} = patract;

describe('ERC20', () => {
  after(() => {
    return disconnect();
  });

  async function setup() {
    const one = new BN(10).pow(new BN(api.registry.chainDecimals));
    const signers = await getSigners();
    const Alice = signers[0];
    const sender = await getRandomSigner(Alice, one.muln(10));
    const contractFactory = await getContractFactory('erc20', sender);
    const contract = await contractFactory.deploy('new', '1000');
    const abi = getAbi('erc20');
    const receiver = await getRandomSigner();

    return { sender, contractFactory, contract, abi, receiver, Alice, one };
  }

  it('Assigns initial balance', async () => {
    const { contract, sender } = await setup();
    const result = await contract.query.balanceOf(sender.address);
    expect(result.output).to.equal(1000);
  });

  it('Transfer adds amount to destination account', async () => {
    const { contract, receiver } = await setup();

    await expect(() =>
      contract.tx.transfer(receiver.address, 7)
    ).to.changeTokenBalance(contract, receiver, 7);

    await expect(() =>
      contract.tx.transfer(receiver.address, 7)
    ).to.changeTokenBalances(contract, [contract.signer, receiver], [-7, 7]);
  });

  it('Transfer emits event', async () => {
    const { contract, sender, receiver } = await setup();

    expect(contract.tx.transfer(receiver.address, 7))
      .to.emit(contract, 'Transfer')
      .withArgs(sender.address, receiver.address, 7);
  });

  it('Can not transfer above the amount', async () => {
    const { contract, receiver } = await setup();

    await expect(contract.tx.transfer(receiver.address, 1007)).to.not.emit(
      contract,
      'Transfer'
    );
  });

  it('Can not transfer from empty account', async () => {
    const { contract, Alice, one, sender } = await setup();

    const emptyAccount = await getRandomSigner(Alice, one.muln(10));

    await expect(
      contract.tx.transfer(sender.address, 7, {
        signer: emptyAccount
      })
    ).to.not.emit(contract, 'Transfer');
  });
});
```

You can run your tests with `npx redspot test`

```bash
$ npx redspot test

===== Instantiate erc20 =====
Endowment:  20003200000
GasLimit:  400000000000
CodeHash:  0x372f716ec52a6662ff84b9c7670d087fe413ee717efd4c5ff40a9bb213452408
InputData:  0x50d183512be8030000000000000000000000000000
✔ Transaction fees: 2101427891
✔ The gas consumption of erc20 instantiate: 26766000000
✔ erc20 address: 5EZN12RXKxUWdESK9kSBfFt6516FVnZW45TuMF5oXkj4egEP
ℹ Generate random signer: 5G6iEXWUpZGdoogetkau1URB1t3N6i9ZQL84CisuEFtGn7c4
ℹ Mnemonic: dash host stuff tortoise alcohol warm awful artefact expand spoon gloom hover
ℹ Generate random signer: 5G14hV8a3NLKUxt5tczGoPEfGY3ADm7Nt6PBFWuhSyNqYpYj
ℹ Mnemonic: wrist toast layer erosion involve hedgehog rhythm illegal parent copy miracle tent
ℹ Transfer 100000000000 from 5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY to 5G14hV8a3NLKUxt5tczGoPEfGY3ADm7Nt6PBFWuhSyNqYpYj

===== Exec transfer =====
dest:  0x6e53be1dfa20af0403088fa1c94748bf1864e60016a910a9005b0e520ac8a145
value:  0
gasLimit:  400000000000
inputData:  0xd0fae3a09da4d7bfa17ea2d60835ca3c5fac7ea6ca6e18f32f842562d69adf7b7e5742f51307000000000000000000000000000000
✔ Execute successfully
✔ https://polkadot.js.org/apps/#/explorer/query/0x62b09ff094c9259df70832e35845a609b5b5b7a8217ba8c8263eb7ab24e39182
  ✓ Can not transfer from empty account (4007ms)


  5 passing (16s)
```

### Deploying contract

To deploy the contract we will use a Redspot script. Inside scripts/ you will find deploy.ts with the following code:

```javascript
import { patract, network } from "redspot";

const { getContractFactory, disconnect } = patract!;

const uri =
  "bottom drive obey lake curtain smoke basket hold race lonely fit walk//Alice";

const { connect, api } = patract!;

async function run() {
  await connect();

  const signer = network.provider.createSigner(
    network.provider.keyring.createFromUri(uri)
  );

  const contractFactory = await getContractFactory("erc20", signer);

  const balance = await api.query.system.account(signer.address);

  console.log("Balance: ", balance.toHuman());

  const contract = await contractFactory.deployed("new", "1000000", {
    gasLimit: "200000000000",
    value: "10000000000000000",
  });

  console.log("");
  console.log(
    "Deploy successfully. The contract address: ",
    contract.address.toString()
  );

  disconnect();
}

run().catch((err) => {
  console.log(err);
});
```

Run it with `npx redspot run scripts/deploy.ts`:

```bash
===== Instantiate erc20 =====
Endowment:  10000000000000000
GasLimit:  200000000000
CodeHash:  0x372f716ec52a6662ff84b9c7670d087fe413ee717efd4c5ff40a9bb213452408
InputData:  0x50d183512b40420f00000000000000000000000000
✔ Transaction fees: 2319536570
✔ The gas consumption of erc20 instantiate: 26766000000
✔ erc20 address: 5FX3AbZFE1jedXSMT3C8uXbDLDjp6AyAer56TzwewtWrahHQ

Deploy successfully. The contract address:  5FX3AbZFE1jedXSMT3C8uXbDLDjp6AyAer56TzwewtWrahHQ

ERROR  Disconnected from ws://192.168.1.165:9944: 1000:: Normal connection closure
```
